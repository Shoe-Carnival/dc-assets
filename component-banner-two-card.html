<html>
  <head>
    <!-- A version of jquery for easy data loading -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"
    ></script>
    <!-- Load the Amplience CMS Inline SDK available from https://bitbucket.org/amplience/cms-javascript-sdk branch:develop -->
    <script
      type="text/javascript"
      src="https://c1.adis.ws/c/playground/cms-javascript-sdk.min"
    ></script>
    <!-- include the handlebars runtime -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"
    ></script>
    <!-- Some example styling -->
    <style>
      /* HTML reset to use border box sizing*/
      html,
      body {
        box-sizing: border-box;
      }
      body * {
        box-sizing: inherit;
      }
      .banner {
        display: flex;
      }

      .banner img {
        width: 50%;
      }
    </style>
  </head>
  <body>
    <div id="contentRender"></div>
    <!-- Handlebars Template to render content -->
    <script id="tutorial-template" type="text/x-handlebars-template">
      <div class="banner">
        <!-- construct image URL from the data. Chose to default to HTTPS -->
        {{#each banners}}
          <img
            class="banner-background-image"
            src="https://{{this.banner.picture.desktop.defaultHost}}/i/{{this.banner.picture.desktop.endpoint}}/{{
              this.banner.picture.desktop.name
            }}?qlt=25"
          />
        {{/each}}
      </div>
    </script>
    <!-- Load data, inline attributes and render via template -->
    <script>
      var contentDeliveryUrl =
        "//" +
        getQueryVar("api") +
        "/cms/content/query?fullBodyObject=true&query=" +
        encodeURIComponent(
          JSON.stringify({
            "sys.iri":
              "http://content.cms.amplience.com/" + getQueryVar("content"),
          })
        ) +
        "&scope=tree&store=store";

      console.log("This is the URL");
      console.log(contentDeliveryUrl);

      var deliveryRequest = $.ajax({
        url: contentDeliveryUrl,
      });
      // render the content or display error response
      deliveryRequest.done(renderContent).fail(showErrorMessage);
      function renderContent(data) {
        console.log("This is the result in JSON-LD:");
        console.log(JSON.stringify(data));
        console.log("---");
        // use the Amplience CMS JavaScript SDK to manipulate the JSON-LD into a content tree
        var contentTree = amp.inlineContent(data)[0];

        // This is the new content
        console.log("This is the result inlined:");
        console.log(JSON.stringify(contentTree, null, 2));
        console.log("---");
        // fetch the Handlebars template from the DOM
        var templateSource = $("#tutorial-template").html();
        var template = Handlebars.compile(templateSource);

        // render the content using the template
        var html = template(contentTree);
        $("#contentRender").html(html);
      }
      function showErrorMessage(err) {
        console.log("Delivery API Request Failure", err);
        $(document.body).append(
          '<div class="error">An error occurred retrieving your content.<br/><br/>Please ensure that it is published.<br/><br/>Details of the error have been saved to the browser console.</div>'
        );
      }

      function getQueryVar(variable) {
        var query = window.location.search.substring(1);
        console.log("query");
        console.log(query);

        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split("=");
          if (decodeURIComponent(pair[0]) == variable) {
            console.log("decoded URL");
            console.log(decodeURIComponent(pair[1]));

            return decodeURIComponent(pair[1]);
          }
        }
        return false;
      }
    </script>
  </body>
</html>
